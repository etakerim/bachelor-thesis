 \thispagestyle{empty}
\setcounter{figure}{0}
\chapter{Používateľská príručka}
\pagenumbering{arabic}
\renewcommand*{\thepage}{C-\arabic{page}}

\section{Inštalačný manuál}
Špecifikovať testovaciu platformu
(esp-idf) v4.4, FreeRTOS v9.0.0, esp-dsp v1.2, MPack v1.1, CMake - nástroj na automatizácie kompilácie (GNU 8.4.0), Platforma Manjaro Linux
	Linux ThinkPad 5.10.109-1-MANJARO (\url{https://ludocode.github.io/mpack/md_docs_expect.html}), Verzie a návod na inštaláciu v prílohe
- Python3.10, numpy, scipy (stats, signal, fft, interpolate), pandas, seaborn, matplotlib
- msgpack, json, cmd,  Eclipse Mosquitto

sudo pacman -S --needed gcc git make flex bison gperf python-pip cmake ninja ccache dfu-util libusb
\url{git clone -b v4.4 --recursive https://github.com/espressif/esp-idf.git}
\url{git clone -b v1.2.0 https://github.com/espressif/esp-dsp.git}
\url{wget https://github.com/ludocode/mpack/releases/download/v1.1/mpack-amalgamation-1.1.tar.gz}


cd ~/esp/esp-idf
./install.sh esp32


\textbf{Flashovanie a sprevádzkovanie}
\begin{lstlisting}[style=messages]
. ./export.sh
cd firmware/vibration-analyzer
idf.py build
idf.py -p /dev/ttyUSB0 flash
idf.py -p /dev/ttyUSB0 monitor
\end{lstlisting}

na SD kartu dať: config.txt

na MQTT server dať: mosquitto.conf
systemctl status


\section{Návod na použitie}
\textbf{MQTT klient na nahrávanie konfigurácií}
cd  main/tests/
pip install -r requirements.txt
python config\_tool.py

Príkazy:
\begin{itemize}[noitemsep, topsep=0pt]
	\item \textbf{connect}
		Device ID [1]:
      	Broker IP [192.168.1.103]
        Broker Port [1883]
	\item \textbf{disconnect}
	\item \textbf{end}
	\item \textbf{^C}
	\item \textbf{set}
		config>
	\item \textbf{config}
	\item \textbf{topic}
		topic>
		Listen time on topic in sec [10]:
	\item \textbf{login}
	\item \textbf{credentials}
\end{itemize}

\url{https://github.com/espressif/esp-idf}
\url{https://github.com/espressif/esp-dsp} s úpravou
\url{https://github.com/ludocode/mpack/releases/download/v1.1/mpack-amalgamation-1.1.tar.gz}

\textbf{Jupyter notebooky}
\begin{lstlisting}[style=messages]
cd measurements
pip install -r requirements.txt
jupyter notebook
\end{lstlisting}

\section{Replikácia experimentov}

Dôležité prepínače kompilátora cez \verb|idf.py menuconfig|:
    - Optimalizácia na veľkosť: -Os (\verb|CONFIG_COMPILER_OPTIMIZATION_SIZE=y|)
    - Taktovacia frekvencia: 160 MHz   (\verb|CONFIG_ESP32_DEFAULT_CPU_FREQ_MHZ=160|)
    - Tick operačného systému: 100 Hz tick  (\verb|CONFIG_FREERTOS_HZ=100|)
    
Kompilovanie a nahratie na ESP32:

\begin{lstlisting}[style=messages]
$ idf.py build
$ idf.py flash
\end{lstlisting}

Nastav počiatočnú konfiguráciu nástrojom \verb|python config_tool.py|:

\begin{lstlisting}[style=messages]
-> connect
-> set
    {"sensor": {"fs": 8, "range": "2g", "n": 8, "overlap": 0.5, "axis": [true, true, true]}, "tsmooth": {"on": false, "n": 8, "repeat": 1}, "stats": {"min": true, "max": true, "rms": true, "avg": true, "var": true, "std": true, "skew": true, "kurtosis": true, "med": true, "mad": true, "corr": false}, "transform": {"w": "hann", "f": "dft", "log": true}, "fsmooth": {"on": false, "n": 8, "repeat": 1}, "peak": {"tmin": 4, "tprox": 5, "strategy": "threshold", "threshold": {"t": -15.0}, "neighbours": {"k": 9, "e": 0.0, "h": -100.0, "h_rel": 10.0}, "zero_crossing": {"k": 4, "slope": 3.0}, "hill_walker": {"t": 0.0, "h": 0, "p": 10.0, "i": 3.0}}, "logger": {"local": false, "mqtt": true, "samples": "", "stats": false, "events": false, "subsamp": 1}}
\end{lstlisting}

\section{Experiment: Časová efektivita algoritmov na spracovanie signálu}
V \emph{main.c} je potrebné sa presvedčiť, že z direktív pre meranie je odkomentovaná len direktíva: 
\verb|MEMORY_MEASUREMENT|

Po každom riadku nastavením novej konfigurácie je potrebné čakať na 10 meraní časov z 
\begin{lstlisting}[style=messages]
idf.py monitor | tee memory_usage.txt
\end{lstlisting}

\begin{lstlisting}[style=messages]
-> set
{"sensor": {"n": 8}, "tsmooth": {"n": 8}, "fsmooth": {"n": 8}}
{"sensor": {"n": 16}, "tsmooth": {"n": 16}, "fsmooth": {"n": 16}}
{"sensor": {"n": 32}, "tsmooth": {"n": 32}, "fsmooth": {"n": 32}}
{"sensor": {"n": 64}, "tsmooth": {"n": 64}, "fsmooth": {"n": 64}}
{"sensor": {"n": 128}, "tsmooth": {"n": 128}, "fsmooth": {"n": 128}}
{"sensor": {"n": 256}, "tsmooth": {"n": 256}, "fsmooth": {"n": 256}}
{"sensor": {"n": 512}, "tsmooth": {"n": 512}, "fsmooth": {"n": 512}}
{"sensor": {"n": 1024}, "tsmooth": {"n": 1024}, "fsmooth": {"n": 1024}}
\end{lstlisting}

Následné fitrovanie relevantných riadkov:
\begin{lstlisting}[style=messages]
$ sed -rn 's/^(.*)(MEM.*)$/\2/p' memory_usage.txt > memory_usage_filter.csv
\end{lstlisting}


\section{Experiment: Časová efektivita algoritmov na spracovanie signálu}

V \emph{main.c} je potrebné sa presvedčiť, že z direktív pre meranie je odkomentovaná len direktíva: 
\verb|EXECUTION_TIME_ALGORITHMS|.

Nastav počiatočnú konfiguráciu nástrojom \verb|python config_tool.py|:
\begin{lstlisting}[style=messages]
{"sensor": {"axis": [false, false, true]}}
\end{lstlisting}

Po každom riadku nastavením novej konfigurácie je potrebné čakať na 10 meraní časov z 
\begin{lstlisting}[style=messages]
idf.py monitor | tee execution_algorithms.txt
\end{lstlisting}

\begin{lstlisting}[style=messages]
{"sensor": {"n": 32, "fs": 16}, "transform": {"f": "dft"}, "peak": {"strategy": "neighbours"}}
{"sensor": {"n": 32, "fs": 16}, "transform": {"f": "dft"}, "peak": {"strategy": "zero_crossing"}}
{"sensor": {"n": 32, "fs": 16}, "transform": {"f": "dft"}, "peak": {"strategy": "hill_walker"}}
{"sensor": {"n": 32, "fs": 16}, "transform": {"f": "dct"}, "peak": {"strategy": "neighbours"}}
\end{lstlisting}

Medzi každým:
\begin{lstlisting}[style=messages]
{"sensor": {"n": 64, "fs": 32}}
{"sensor": {"n": 128, "fs": 64}}
{"sensor": {"n": 256, "fs": 128}}
{"sensor": {"n": 512, "fs": 256}}
{"sensor": {"n": 1024, "fs": 512}}
\end{lstlisting}



\section{Experiment: Časová efektivita vyhladzovacieho filtra}

V \emph{main.c} je potrebné sa presvedčiť, že z direktív pre meranie je odkomentovaná len direktíva:
\verb|EXECUTION_TIME_SMOOTHING|.

Nastav počiatočnú konfiguráciu nástrojom \verb|python config_tool.py|:

\begin{lstlisting}[style=messages]
{"sensor": {"fs": 256, "n": 512, "axis": [false, false, true]},  {"tsmooth": {"on": true}}
\end{lstlisting}

Po každom riadku nastavením novej konfigurácie je potrebné čakať na 10 meraní časov:
\begin{lstlisting}[style=messages]
idf.py monitor | tee execution_time.txt
\end{lstlisting}

\begin{lstlisting}[style=messages]
-> set
{"tsmooth": {"n": 4, "repeat": 1}}
{"tsmooth": {"n": 16, "repeat": 1}}
{"tsmooth": {"n": 64, "repeat": 1}}
{"tsmooth": {"n": 4, "repeat": 4}}
{"tsmooth": {"n": 16, "repeat": 4}}
{"tsmooth": {"n": 64, "repeat": 4}}
{"tsmooth": {"n": 4, "repeat": 8}}
{"tsmooth": {"n": 16, "repeat": 8}}
{"tsmooth": {"n": 64, "repeat": 8}}
\end{lstlisting}


\section{Experiment: Časová efektivita dátovej pipeline}

V \emph{main.c} je potrebné sa presvedčiť, že z direktív pre meranie je odkomentovaná len nasledovná: 
\verb|EXECUTION_TIME_PIPELINE|.

Nastav počiatočnú konfiguráciu nástrojom \verb|python config_tool.py|:


{"sensor": {"fs": 16, "range": "2g", "n": 32, "overlap": 0.5, "axis": [false, false, true]}, "stats": {"min": false, "max": false, "rms": false, "avg": false, "var": false, "std": false, "skew": false, "kurtosis": false, "med": false, "mad": false, "corr": false}}
```

Po každom riadku nastavením novej konfigurácie je potrebné čakať na 10 meraní časov: 
\begin{lstlisting}[style=messages]
idf.py monitor | tee execution_time.txt
\end{lstlisting}

\paragraph{Tabuľka A}

\begin{lstlisting}[style=messages]
-> set
{"sensor": {"fs": 16, "n": 32, "axis": [false, false, true]}, "transform": {"f": "dft", "log": true}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 128, "n": 256}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 512, "n": 1024}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 16, "n": 32, "axis": [false, false, true]}, "transform": {"f": "dct", "log": true}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 128, "n": 256}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 512, "n": 1024}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}
\end{lstlisting}

\paragraph{Tabuľka B (9x) - 3 osi}

\begin{lstlisting}[style=messages]
{"sensor": {"fs": 16, "n": 32, "axis": [true, true, true]}, "transform": {"f": "dft", "log": true}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 128, "n": 256}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 512, "n": 1024}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 16, "n": 32, "axis": [true, true, true]}, "transform": {"f": "dct", "log": true}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 128, "n": 256}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 512, "n": 1024}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}
\end{lstlisting}

\paragraph{Tabuľka C (stats)}

\begin{lstlisting}[style=messages]
{"sensor": {"fs": 16, "n": 32, "axis": [false, false, true]},  "stats": {"min": true, "max": true, "rms": true, "avg": true, "var": true, "std": true, "skew": true, "kurtosis": true, "med": true, "mad": true, "corr": true},  "logger": {"samples": "f", "stats": true}, "transform": {"f": "dft", "log": true}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 128, "n": 256}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 512, "n": 1024}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}
\end{lstlisting}

\paragraph{Tabuľka D}

\begin{lstlisting}[style=messages]
{"sensor": {"fs": 16, "n": 32, "axis": [true, true, true]}, "transform": {"f": "dft", "log": true}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 128, "n": 256}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}

{"sensor": {"fs": 512, "n": 1024}, "peak": {"strategy": "neighbours"}}
{"peak": {"strategy": "zero_crossing"}}
{"peak": {"strategy": "hill_walker"}}
\end{lstlisting}

Pre namiesto X: A, B, C, D

\begin{lstlisting}[style=messages]
sed -rn '/^(.*)(main:.*)$/p' pipeline_time-X.txt > pipeline_time-X_filter.csv
\end{lstlisting}



